@model CafeWebsite.Models.OrderViewModel
@{
    ViewData["Title"] = "Đặt hàng";
}

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Đặt hàng</h1>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Order Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Thông tin đặt hàng</h2>
                
                <form asp-action="PlaceOrder" method="post">
                    <div class="space-y-4">
                        <div>
                            <label asp-for="CustomerName" class="block text-sm font-medium text-gray-700 mb-2">Họ và tên *</label>
                            <input asp-for="CustomerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required />
                            <span asp-validation-for="CustomerName" class="text-red-500 text-sm"></span>
                        </div>
                        
                        <div>
                            <label asp-for="CustomerPhone" class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại *</label>
                            <input asp-for="CustomerPhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required />
                            <span asp-validation-for="CustomerPhone" class="text-red-500 text-sm"></span>
                        </div>
                        
                        <div>
                            <label asp-for="CustomerEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input asp-for="CustomerEmail" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" />
                            <span asp-validation-for="CustomerEmail" class="text-red-500 text-sm"></span>
                        </div>
                        
                        <div>
                            <label asp-for="CustomerAddress" class="block text-sm font-medium text-gray-700 mb-2">Địa chỉ giao hàng *</label>
                            <textarea asp-for="CustomerAddress" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required></textarea>
                            <span asp-validation-for="CustomerAddress" class="text-red-500 text-sm"></span>
                        </div>
                        
                        <div>
                            <label asp-for="Notes" class="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                            <textarea asp-for="Notes" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ghi chú thêm cho đơn hàng..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mã khuyến mãi</label>
                            <div class="flex">
                                <input asp-for="PromotionCode" id="promotionCode" class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Nhập mã khuyến mãi" />
                                <button type="button" onclick="applyPromotion()" class="bg-amber-600 text-white px-6 py-2 rounded-r-lg hover:bg-amber-700 transition-colors">
                                    Áp dụng
                                </button>
                            </div>
                            <div id="promotionMessage" class="mt-2 text-sm"></div>
                        </div>
                        
                        <div>
                            <label asp-for="PaymentMethod" class="block text-sm font-medium text-gray-700 mb-2">Phương thức thanh toán</label>
                            <select asp-for="PaymentMethod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="COD">Thanh toán khi nhận hàng (COD)</option>
                                <option value="MoMo">MoMo</option>
                                <option value="ZaloPay">ZaloPay</option>
                                <option value="BankTransfer">Chuyển khoản ngân hàng</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" name="DiscountAmount" id="hiddenDiscount" value="0" />
                    
                    <div class="mt-8">
                        <button type="submit" onclick="updateHiddenFields()" class="w-full bg-amber-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-amber-700 transition-colors">
                            Đặt hàng ngay
                        </button>
                    </div>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Tóm tắt đơn hàng</h2>
                
                <div class="space-y-4 mb-6">
                    @foreach (var item in Model.Items)
                    {
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">@item.Product?.Name</h4>
                                <p class="text-sm text-gray-600">Size @item.Size × @item.Quantity</p>
                            </div>
                            <span class="font-semibold text-gray-900">@item.Total.ToString("N0") đ</span>
                        </div>
                    }
                </div>
                
                <div class="border-t border-gray-200 pt-4 space-y-2">
                    <div class="flex justify-between items-center">
                        <span>Tạm tính:</span>
                        <span id="subtotal">@Model.Subtotal.ToString("N0") đ</span>
                    </div>
                    <div class="flex justify-between items-center text-green-600" id="discountRow" style="display: none;">
                        <span>Giảm giá:</span>
                        <span id="discountAmount">0 đ</span>
                    </div>
                    <div class="flex justify-between items-center text-lg font-semibold border-t pt-2">
                        <span>Tổng cộng:</span>
                        <span class="text-amber-600" id="finalTotal">@Model.Total.ToString("N0") đ</span>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-amber-50 rounded-lg">
                    <div class="flex items-start">
                        <i data-lucide="info" class="h-5 w-5 text-amber-600 mt-0.5 mr-2"></i>
                        <div class="text-sm text-amber-800">
                            <p class="font-medium mb-1">Thông tin giao hàng:</p>
                            <p>• Thời gian giao hàng: 30-45 phút</p>
                            <p>• Phí giao hàng: Miễn phí trong bán kính 5km</p>
                            <p>• Hotline hỗ trợ: 1900 1234</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentDiscount = 0;
        let currentPromotionId = '';
        
        function applyPromotion() {
            const code = $('#promotionCode').val();
            const subtotal = @Model.Subtotal;
            
            if (!code) {
                showPromotionMessage('Vui lòng nhập mã khuyến mãi', 'error');
                return;
            }
            
            $.post('/Promotion/ValidateCode', {
                code: code,
                orderTotal: subtotal
            }, function(response) {
                if (response.success) {
                    currentDiscount = response.discountAmount;
                    currentPromotionId = response.promotionId;
                    
                    $('#discountAmount').text(formatCurrency(currentDiscount));
                    $('#discountRow').show();
                    $('#finalTotal').text(formatCurrency(subtotal - currentDiscount));
                    
                    showPromotionMessage(response.message, 'success');
                } else {
                    resetDiscount();
                    showPromotionMessage(response.message, 'error');
                }
            });
        }
        
        function resetDiscount() {
            currentDiscount = 0;
            currentPromotionId = '';
            $('#discountRow').hide();
            $('#finalTotal').text($('#subtotal').text());
        }
        
        function showPromotionMessage(message, type) {
            const messageDiv = $('#promotionMessage');
            messageDiv.removeClass('text-green-600 text-red-600')
                     .addClass(type === 'success' ? 'text-green-600' : 'text-red-600')
                     .text(message);
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' đ';
        }
        
        function updateHiddenFields() {
            $('#hiddenDiscount').val(currentDiscount);
        }
        
        $(document).ready(function() {
            lucide.createIcons();
        });
    </script>
}