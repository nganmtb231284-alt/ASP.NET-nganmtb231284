@model List<CafeWebsite.Models.Order>
@{
    ViewData["Title"] = "Quản lý đơn hàng";
}

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Quản lý đơn hàng</h1>
        </div>

        <!-- Navigation -->
        <div class="mb-8">
            <nav class="flex space-x-4">
                <a asp-action="Dashboard" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Dashboard</a>
                <a asp-action="Products" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Sản phẩm</a>
                <a asp-action="Orders" class="bg-amber-600 text-white px-4 py-2 rounded-lg">Đơn hàng</a>
            </nav>
        </div>

        <!-- Status Filter -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Lọc theo trạng thái</h3>
            </div>
            <div class="p-6">
                <div class="flex flex-wrap gap-2">
                    <a asp-action="Orders" class="px-4 py-2 rounded-full text-sm font-medium @(ViewBag.SelectedStatus == null ? "bg-amber-600 text-white" : "bg-gray-200 text-gray-700 hover:bg-gray-300")">
                        Tất cả (@Model.Count)
                    </a>
                    <a asp-action="Orders" asp-route-status="Pending" class="px-4 py-2 rounded-full text-sm font-medium @(ViewBag.SelectedStatus?.ToString() == "Pending" ? "bg-yellow-600 text-white" : "bg-yellow-100 text-yellow-800 hover:bg-yellow-200")">
                        Chờ xác nhận (@Model.Count(o => o.Status == OrderStatus.Pending))
                    </a>
                    <a asp-action="Orders" asp-route-status="Confirmed" class="px-4 py-2 rounded-full text-sm font-medium @(ViewBag.SelectedStatus?.ToString() == "Confirmed" ? "bg-blue-600 text-white" : "bg-blue-100 text-blue-800 hover:bg-blue-200")">
                        Đã xác nhận (@Model.Count(o => o.Status == OrderStatus.Confirmed))
                    </a>
                    <a asp-action="Orders" asp-route-status="Preparing" class="px-4 py-2 rounded-full text-sm font-medium @(ViewBag.SelectedStatus?.ToString() == "Preparing" ? "bg-orange-600 text-white" : "bg-orange-100 text-orange-800 hover:bg-orange-200")">
                        Đang chuẩn bị (@Model.Count(o => o.Status == OrderStatus.Preparing))
                    </a>
                    <a asp-action="Orders" asp-route-status="Delivering" class="px-4 py-2 rounded-full text-sm font-medium @(ViewBag.SelectedStatus?.ToString() == "Delivering" ? "bg-purple-600 text-white" : "bg-purple-100 text-purple-800 hover:bg-purple-200")">
                        Đang giao (@Model.Count(o => o.Status == OrderStatus.Delivering))
                    </a>
                    <a asp-action="Orders" asp-route-status="Completed" class="px-4 py-2 rounded-full text-sm font-medium @(ViewBag.SelectedStatus?.ToString() == "Completed" ? "bg-green-600 text-white" : "bg-green-100 text-green-800 hover:bg-green-200")">
                        Hoàn thành (@Model.Count(o => o.Status == OrderStatus.Completed))
                    </a>
                </div>
            </div>
        </div>

        <!-- Orders List -->
        <div class="space-y-6">
            @foreach (var order in Model)
            {
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Đơn hàng #@order.Id.Substring(0, 8)</h3>
                                <p class="text-sm text-gray-500">@order.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full @(
                                    order.Status == OrderStatus.Pending ? "bg-yellow-100 text-yellow-800" :
                                    order.Status == OrderStatus.Confirmed ? "bg-blue-100 text-blue-800" :
                                    order.Status == OrderStatus.Preparing ? "bg-orange-100 text-orange-800" :
                                    order.Status == OrderStatus.Delivering ? "bg-purple-100 text-purple-800" :
                                    order.Status == OrderStatus.Completed ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800")">
                                    @(order.Status == OrderStatus.Pending ? "Chờ xác nhận" :
                                      order.Status == OrderStatus.Confirmed ? "Đã xác nhận" :
                                      order.Status == OrderStatus.Preparing ? "Đang chuẩn bị" :
                                      order.Status == OrderStatus.Delivering ? "Đang giao" :
                                      order.Status == OrderStatus.Completed ? "Hoàn thành" : "Đã hủy")
                                </span>
                                <span class="text-lg font-bold text-gray-900">@order.Total.ToString("N0") đ</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Customer Info -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Thông tin khách hàng</h4>
                                <div class="space-y-2 text-sm">
                                    <div><strong>Tên:</strong> @order.CustomerName</div>
                                    <div><strong>Điện thoại:</strong> @order.CustomerPhone</div>
                                    @if (!string.IsNullOrEmpty(order.CustomerEmail))
                                    {
                                        <div><strong>Email:</strong> @order.CustomerEmail</div>
                                    }
                                    <div><strong>Địa chỉ:</strong> @order.CustomerAddress</div>
                                    @if (!string.IsNullOrEmpty(order.Notes))
                                    {
                                        <div><strong>Ghi chú:</strong> @order.Notes</div>
                                    }
                                </div>
                            </div>
                            
                            <!-- Order Items -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Chi tiết đơn hàng</h4>
                                <div class="space-y-2">
                                    @foreach (var item in order.Items)
                                    {
                                        <div class="flex justify-between text-sm">
                                            <span>@item.ProductName (Size @item.Size) x@item.Quantity</span>
                                            <span>@item.Total.ToString("N0") đ</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Update -->
                        @if (order.Status != OrderStatus.Completed && order.Status != OrderStatus.Cancelled)
                        {
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Cập nhật trạng thái</h4>
                                <div class="flex space-x-2">
                                    @if (order.Status == OrderStatus.Pending)
                                    {
                                        <button onclick="updateOrderStatus('@order.Id', 'Confirmed')" 
                                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                            Xác nhận đơn hàng
                                        </button>
                                        <button onclick="updateOrderStatus('@order.Id', 'Cancelled')" 
                                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                            Hủy đơn hàng
                                        </button>
                                    }
                                    @if (order.Status == OrderStatus.Confirmed)
                                    {
                                        <button onclick="updateOrderStatus('@order.Id', 'Preparing')" 
                                                class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 text-sm">
                                            Bắt đầu chuẩn bị
                                        </button>
                                    }
                                    @if (order.Status == OrderStatus.Preparing)
                                    {
                                        <button onclick="updateOrderStatus('@order.Id', 'Delivering')" 
                                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm">
                                            Bắt đầu giao hàng
                                        </button>
                                    }
                                    @if (order.Status == OrderStatus.Delivering)
                                    {
                                        <button onclick="updateOrderStatus('@order.Id', 'Completed')" 
                                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                            Hoàn thành đơn hàng
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        @if (!Model.Any())
        {
            <div class="text-center py-16">
                <i data-lucide="shopping-bag" class="h-16 w-16 text-gray-400 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Không có đơn hàng</h3>
                <p class="text-gray-600">Chưa có đơn hàng nào với bộ lọc hiện tại</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function updateOrderStatus(orderId, newStatus) {
            if (confirm('Bạn có chắc muốn cập nhật trạng thái đơn hàng?')) {
                $.post('/Admin/UpdateOrderStatus', {
                    orderId: orderId,
                    newStatus: newStatus
                }, function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Có lỗi xảy ra: ' + response.message);
                    }
                });
            }
        }
        
        $(document).ready(function() {
            lucide.createIcons();
        });
    </script>
}